# OpenAPI Documentation

This document provides information about the OpenAPI implementation in the Sudal Social Quiz Platform backend.

## Overview

The project uses [ogen-go/ogen](https://github.com/ogen-go/ogen) to generate OpenAPI server code from OpenAPI 3.0 specifications. This approach ensures that the API documentation stays in sync with the actual implementation and provides automatic code generation for REST endpoints.

## Architecture

### Components

1. **OpenAPI Specification** (`api/openapi.yaml`): The source of truth for REST API definitions
2. **Generated Server Code** (`internal/infrastructure/openapi/oas_*.go`): Auto-generated by ogen
3. **Handler Implementation** (`internal/infrastructure/openapi/handler.go`): Custom implementation of the generated interfaces
4. **Swagger UI Handler** (`internal/infrastructure/openapi/swagger.go`): Serves the Swagger UI interface

### Integration

The OpenAPI server is integrated into the main HTTP server alongside existing REST endpoints and Connect-go gRPC services:

- **OpenAPI Endpoints**: `/api/*` - Generated REST endpoints
- **Swagger UI**: `/docs` - Interactive API documentation
- **OpenAPI Spec**: `/api/openapi.yaml` - Raw OpenAPI specification

## Available Endpoints

### Health Check Endpoints

All health check endpoints are available through both the original REST handlers and the OpenAPI-generated handlers:

#### Ping
- **Endpoint**: `GET /api/ping`
- **Description**: Simple health check to verify service availability
- **Response**: `{"status": "ok"}`

#### Health Check
- **Endpoint**: `GET /api/healthz`
- **Description**: Comprehensive health check including dependencies
- **Response**: `{"status": "healthy|unhealthy"}`

#### Database Health
- **Endpoint**: `GET /api/health/database`
- **Description**: Database connectivity and status check
- **Response**: `{"status": "healthy|unhealthy", "database": "connected|disconnected"}`

## Code Generation

### Automatic Generation

The OpenAPI server code is automatically generated from the OpenAPI specification using ogen. This ensures:

1. **Type Safety**: All request/response types are generated with proper validation
2. **Consistency**: API behavior matches the specification exactly
3. **Maintainability**: Changes to the API only require updating the specification

### Generated Files

The following files are automatically generated and should **not** be edited manually:

- `internal/infrastructure/openapi/oas_*.go` - All files matching this pattern
- These files are excluded from version control via `.gitignore`

The following files are manually maintained and should be committed to version control:

- `api/openapi.yaml` - OpenAPI specification (source of truth)
- `internal/infrastructure/openapi/handler.go` - Custom handler implementations
- `internal/infrastructure/openapi/swagger.go` - Swagger UI handler

### Generation Commands

```bash
# Generate OpenAPI code only
make ogen-generate

# Clean generated OpenAPI code
make ogen-clean

# Generate all code (including OpenAPI)
make generate
```

### Manual Generation

If you need to generate the code manually:

```bash
# Install ogen if not already installed
go install github.com/ogen-go/ogen/cmd/ogen@latest

# Generate server code
go run github.com/ogen-go/ogen/cmd/ogen \
  -target internal/infrastructure/openapi \
  -package openapi \
  -clean \
  api/openapi.yaml
```

## Development Workflow

### Adding New Endpoints

1. **Update OpenAPI Specification**: Edit `api/openapi.yaml` to add new endpoints
2. **Regenerate Code**: Run `make ogen-generate` to update generated code
3. **Implement Handlers**: Update `internal/infrastructure/openapi/handler.go` with new endpoint logic
4. **Update Dependency Injection**: Add new handlers to `internal/infrastructure/di/wire.go` if needed
5. **Test**: Write tests for the new endpoints

### Modifying Existing Endpoints

1. **Update Specification**: Modify the endpoint definition in `api/openapi.yaml`
2. **Regenerate Code**: Run `make ogen-generate`
3. **Update Implementation**: Modify the handler implementation if needed
4. **Update Tests**: Ensure tests reflect the changes

## Swagger UI

### Accessing the Documentation

The Swagger UI is available at `/docs` when the server is running:

```bash
# Start the server
make run

# Access Swagger UI
open http://localhost:8080/docs
```

### Features

- **Interactive Testing**: Test API endpoints directly from the browser
- **Request/Response Examples**: See example requests and responses
- **Schema Documentation**: Detailed information about request/response schemas
- **Authentication**: Support for API authentication (when implemented)

## Configuration

### OpenAPI Specification

The OpenAPI specification is located at `api/openapi.yaml` and includes:

- **API Information**: Title, description, version, contact information
- **Server Configuration**: Development and production server URLs
- **Endpoint Definitions**: All REST API endpoints with full documentation
- **Schema Definitions**: Request/response models with validation rules
- **Error Responses**: Standardized error response formats

### Code Generation Options

The ogen code generation is configured with the following options:

- **Target Directory**: `internal/infrastructure/openapi`
- **Package Name**: `openapi`
- **Clean Generation**: Removes old generated files before creating new ones
- **Server Generation**: Generates server-side code (not client)

## Best Practices

### Specification Design

1. **Comprehensive Documentation**: Include detailed descriptions for all endpoints and schemas
2. **Consistent Naming**: Use consistent naming conventions for endpoints and parameters
3. **Proper HTTP Status Codes**: Use appropriate status codes for different response scenarios
4. **Schema Validation**: Define proper validation rules for request/response schemas

### Implementation

1. **Error Handling**: Implement proper error handling in custom handlers
2. **Logging**: Add appropriate logging for debugging and monitoring
3. **Testing**: Write comprehensive tests for all endpoints
4. **Performance**: Consider performance implications of generated code

### Maintenance

1. **Regular Updates**: Keep the OpenAPI specification up to date with implementation changes
2. **Version Control**: Track changes to the specification in version control
3. **Documentation**: Update this documentation when making significant changes
4. **Validation**: Regularly validate the specification for correctness

## Troubleshooting

### Common Issues

1. **Generation Failures**: Ensure the OpenAPI specification is valid YAML
2. **Import Errors**: Run `go mod tidy` after generating new code
3. **Handler Mismatches**: Ensure handler implementations match generated interfaces
4. **Dependency Issues**: Update wire configuration when adding new dependencies

### Debugging

1. **Specification Validation**: Use online OpenAPI validators to check specification validity
2. **Generated Code Review**: Review generated code to understand interface requirements
3. **Logging**: Enable debug logging to trace request/response flow
4. **Testing**: Use unit tests to isolate and debug specific issues

## Future Enhancements

### Planned Features

1. **Authentication**: Add API key or JWT authentication support
2. **Rate Limiting**: Implement rate limiting for API endpoints
3. **Versioning**: Support API versioning through URL paths or headers
4. **Monitoring**: Add metrics and monitoring for API usage

### Extension Points

1. **Middleware**: Add custom middleware for cross-cutting concerns
2. **Validation**: Extend validation beyond basic schema validation
3. **Transformation**: Add request/response transformation capabilities
4. **Caching**: Implement response caching for appropriate endpoints
